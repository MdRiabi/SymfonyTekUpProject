{# templates/base.html.twig #}
<!DOCTYPE html>
{% set userTheme = app.user ? app.user.theme : 'system' %}
<html lang="{{ app.request.locale }}" dir="{{ app.request.locale == 'ar' ? 'rtl' : 'ltr' }}" class="{% if userTheme == 'dark' %}dark{% endif %}" data-theme="{{ userTheme }}">
<!-- DEBUG: Current theme = {{ userTheme }} | Dark class applied: {{ userTheme == 'dark' ? 'YES' : 'NO' }} -->
{% if userTheme == 'light' %}
<style id="force-light-mode">
    /* FORCE light mode colors with !important to override browser dark mode */
    html:not(.dark), html:not(.dark) body {
        background-color: #f9fafb !important;
        color: #111827 !important;
    }
    html:not(.dark) header {
        background-color: white !important;
        color: #111827 !important;
    }
    html:not(.dark) aside {
        background-color: white !important;
    }
    html:not(.dark) main {
        background-color: #f9fafb !important;
    }
    html:not(.dark) .bg-white {
        background-color: white !important;
    }
    html:not(.dark) .bg-gray-50 {
        background-color: #f9fafb !important;
    }
    html:not(.dark) .text-gray-900 {
        color: #111827 !important;
    }
    html:not(.dark) .text-gray-700 {
        color: #374151 !important;
    }
    html:not(.dark) .text-gray-600 {
        color: #4b5563 !important;
    }
    html:not(.dark) .text-gray-500 {
        color: #6b7280 !important;
    }
    html:not(.dark) input, html:not(.dark) select, html:not(.dark) textarea {
        background-color: white !important;
        color: #111827 !important;
    }
</style>
{% endif %}
<head>
    {# ======================================================= #}
    {# EN-T√äTE COMMUN √Ä TOUTES LES PAGES               #}
    {# ======================================================= #}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    {# Le titre est dynamique. Chaque page pourra le red√©finir #}
    <title>{% block title %}Admin Dashboard{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    
    <script>
        // Apply theme based on user preference
        (function() {
            const htmlElement = document.documentElement;
            const userTheme = htmlElement.getAttribute('data-theme');
            
            console.log('üé® THEME DEBUG: User theme =', userTheme);
            console.log('üé® THEME DEBUG: Initial classes =', htmlElement.className);
            
            if (userTheme === 'system') {
                // Detect system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                console.log('üé® THEME DEBUG: System prefers dark =', prefersDark);
                if (prefersDark) {
                    htmlElement.classList.add('dark');
                } else {
                    htmlElement.classList.remove('dark');
                }
                
                // Listen for system preference changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (htmlElement.getAttribute('data-theme') === 'system') {
                        if (e.matches) {
                            htmlElement.classList.add('dark');
                        } else {
                            htmlElement.classList.remove('dark');
                        }
                    }
                });
            } else if (userTheme === 'light') {
                console.log('üé® THEME DEBUG: Applying LIGHT mode - removing dark class');
                // Remove dark class for light mode (white backgrounds)
                htmlElement.classList.remove('dark');
                
                // Force style recalculation
                void htmlElement.offsetWidth;
                
                // Double-check after a short delay
                setTimeout(() => {
                    if (htmlElement.classList.contains('dark')) {
                        console.log('‚ö†Ô∏è WARNING: Dark class was re-added! Removing it again...');
                        htmlElement.classList.remove('dark');
                    }
                    console.log('üé® THEME DEBUG: After timeout check, classes =', htmlElement.className);
                }, 100);
                
            } else if (userTheme === 'dark') {
                console.log('üé® THEME DEBUG: Applying DARK mode - ensuring dark class');
                htmlElement.classList.add('dark');
            }
            
            console.log('üé® THEME DEBUG: Final classes =', htmlElement.className);
        })();
    </script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    {# Styles personnalis√©s communs √† toute l'application #}
    <style>
        /* Styles pour la sidebar et les animations */
        .sidebar-item {
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            transform: translateX(4px);
        }
        .project-card {
            transition: all 0.3s ease;
        }
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        .sidebar-visible {
            transform: translateX(0);
        }
        
        /* Overlay pour la sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .sidebar-overlay-active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Sidebar en mode overlay pour mobile */
        .sidebar-overlay-mode {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 60;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Animation pour le bouton hamburger */
        .hamburger-btn {
            transition: all 0.3s ease;
        }
        .hamburger-btn:hover {
            transform: scale(1.05);
        }

        /* RTL Support for Arabic */
        {% if app.request.locale == 'ar' %}
        [dir="rtl"] .sidebar-item:hover {
            transform: translateX(-4px);
        }
        [dir="rtl"] .sidebar-hidden {
            transform: translateX(100%);
        }
        [dir="rtl"] .sidebar-overlay-mode {
            left: auto;
            right: 0;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.1);
        }
        {% endif %}
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 font-sans h-screen overflow-hidden transition-colors duration-200">

    {# ======================================================= #}
    {# BARRA LAT√âRALE (SIDEBAR)                         #}
    {# ======================================================= #}
    {% block sidebar %}
    <!-- Overlay qui s'affiche quand la sidebar est ouverte -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- La sidebar elle-m√™me (cach√©e par d√©faut) -->
    <aside id="sidebar" class="sidebar sidebar-hidden sidebar-overlay-mode w-64 bg-white dark:bg-gray-800 h-full shadow-lg transition-colors duration-200">
        <div class="p-6 border-b dark:border-gray-700 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-folder-open text-blue-600 dark:text-blue-400 text-2xl"></i>
                <h1 id="logoText" class="ml-3 text-xl font-bold text-gray-800 dark:text-gray-100">Admin Dashboard</h1>
            </div>
            <!-- Bouton pour fermer la sidebar (visible sur mobile) -->
            <button id="closeSidebarBtn" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                <i class="fas fa-times text-gray-600 dark:text-gray-300"></i>
            </button>
        </div>
        <nav class="p-4">
            <ul class="space-y-2">
                {# Il serait bien d'utiliser la fonction path() de Twig pour les liens ici #}
                <li>
                    <a href="{{ path('admin_dashboard') }}" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400">
                        <i class="fas fa-tachometer-alt w-7 h-7 text-xl flex-shrink-0 text-slate-400 dark:text-gray-400"></i>
                        <span class="ml-3">{{ 'nav.dashboard'|trans }}</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400">
                        <i class="fas fa-folder-open w-7 h-7 text-xl flex-shrink-0 text-slate-400 dark:text-gray-400"></i>
                        <span class="ml-3">{{ 'nav.projects'|trans }}</span>
                    </a>
                </li>
                <li>
                    <a href="{{ path('admin_manage_users') }}" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400">
                        <i class="fas fa-users w-7 h-7 text-xl flex-shrink-0 text-slate-400 dark:text-gray-400"></i>
                        <span class="ml-3">{{ 'nav.users'|trans }}</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400">
                        <i class="fas fa-cogs w-7 h-7 text-xl flex-shrink-0 text-slate-400 dark:text-gray-400"></i>
                        <span class="ml-3">{{ 'nav.administration'|trans }}</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400">
                        <i class="fas fa-chart-bar w-7 h-7 text-xl flex-shrink-0 text-slate-400 dark:text-gray-400"></i>
                        <span class="ml-3">{{ 'nav.reports'|trans }}</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400">
                        <i class="fas fa-user-circle w-7 h-7 text-xl flex-shrink-0 text-slate-400 dark:text-gray-400"></i>
                        <span class="ml-3">{{ 'nav.profile'|trans }}</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>
    {% endblock %}

    {# ======================================================= #}
    {# CONTENU PRINCIPAL DE LA PAGE (MAIN)               #}
    {# ======================================================= #}
    <main class="h-full pt-16 overflow-y-auto">
        
        {# ======================================================= #}
        {# HAUT DE PAGE (TOPBAR / HEADER)                  #}
        {# ======================================================= #}
        {% block topbar %}
        <header class="fixed top-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700 px-6 py-3 z-50 transition-colors duration-200">
            <div class="flex justify-between items-center">
                <!-- Section de gauche -->
                <div class="flex items-center space-x-4">
                    <!-- Bouton hamburger pour ouvrir la sidebar -->
                    <button id="hamburgerBtn" class="hamburger-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="fas fa-bars text-gray-600 dark:text-gray-300 text-xl"></i>
                    </button>
                </div>

                <!-- Section de droite -->
                <div class="flex items-center space-x-3">
                    <!-- Barre de recherche -->
                    <div class="relative">
                        <input type="text" placeholder="{{ 'common.search_placeholder'|trans }}" class="pl-10 pr-4 py-2 border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-90 text-sm">
                        <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                    </div>
                    <!-- Bouton Notification -->
                    <button class="flex items-center px-3 py-2 border dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 text-sm">
                        <i class="fas fa-filter mr-2"></i>
                        <span>{{ 'common.filter'|trans }}</span>
                    </button>
                    
                    <!-- BOUTON "CR√âER" AVEC MENU D√âROULANT -->
                    <div class="relative">
                        <!-- Le bouton principal -->
                        <button id="createDropdownButton" class="flex items-center px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                            <i class="fas fa-plus mr-2"></i>
                            <span>{{ 'common.create'|trans }}</span>
                            <!-- La fl√®che qui d√©clenche le menu -->
                            <span class="text-white ml-2 text-xs">&#9660;</span>
                        </button>

                        <!-- La liste d√©roulante (cach√©e par d√©faut) -->
                        <div id="createDropdownMenu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                            <div class="py-1">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <i class="fas fa-tasks mr-2 text-gray-400"></i> {{ 'create.task'|trans }}
                                </a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-flag mr-2 text-green-500"></i> {{ 'create.milestone'|trans }}
                                </a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-layer-group mr-2 text-orange-500"></i> {{ 'create.summary_task'|trans }}
                                </a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-exclamation-circle mr-2 text-purple-500"></i> {{ 'create.epic'|trans }}
                                </a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-book mr-2 text-blue-500"></i> {{ 'create.user_story'|trans }}
                                </a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-bug mr-2 text-red-500"></i> {{ 'create.bug'|trans }}
                                </a>
                                <hr class="my-1">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fas fa-folder-plus mr-2 text-gray-400"></i> {{ 'create.new_project'|trans }}
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- MENU PROFIL UTILISATEUR -->
                    <div class="relative ml-3">
                        <button id="profileMenuButton" class="flex items-center text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            {% if app.user and app.user.photoProfil %}
                                <img class="h-8 w-8 rounded-full object-cover" src="{{ vich_uploader_asset(app.user, 'photoFile') }}" alt="Photo de profil">
                            {% elseif app.user %}
                                <img class="h-8 w-8 rounded-full object-cover" src="https://ui-avatars.com/api/?name={{ app.user.prenom }}+{{ app.user.nom }}&background=random&size=128" alt="Photo de profil">
                            {% else %}
                                <img class="h-8 w-8 rounded-full object-cover" src="https://ui-avatars.com/api/?name=User&background=random&size=128" alt="Photo de profil">
                            {% endif %}
                        </button>
                        <!-- Menu d√©roulant (cach√© par d√©faut) -->
                        <div id="profileDropdown" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-50">
                            <div class="py-1">
                                <a href="{{ path('admin_profile') }}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-user mr-2"></i> {{ 'nav.profile'|trans }}</a>
                                
                                <hr class="my-1">
                                <a href="{{ path('app_logout') }}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"><i class="fas fa-sign-out-alt mr-2"></i> {{ 'nav.logout'|trans }}</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        {% endblock %}

        {# ======================================================= #}
        {# BLOC DYNAMIQUE : LE CONTENU SP√âCIFIQUE √Ä CHAQUE PAGE #}
        {# ======================================================= #}
        {% block body %}{% endblock %}

    </main>

    {# ======================================================= #}
    {# SCRIPTS JAVASCRIPT COMMUNS                        #}
    {# ======================================================= #}
    {% block javascripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- √âl√©ments de la Sidebar ---
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const closeSidebarBtn = document.getElementById('closeSidebarBtn');
            let sidebarVisible = false;

            // --- √âl√©ments du Menu Profil ---
            const profileMenuButton = document.getElementById('profileMenuButton');
            const profileDropdown = document.getElementById('profileDropdown');

            // --- Fonctions pour la Sidebar ---
            function openSidebar() {
                if (sidebar && sidebarOverlay) {
                    sidebarVisible = true;
                    sidebar.classList.remove('sidebar-hidden');
                    sidebar.classList.add('sidebar-visible');
                    sidebarOverlay.classList.add('sidebar-overlay-active');
                }
            }

            function closeSidebar() {
                if (sidebar && sidebarOverlay) {
                    sidebarVisible = false;
                    sidebar.classList.remove('sidebar-visible');
                    sidebar.classList.add('sidebar-hidden');
                    sidebarOverlay.classList.remove('sidebar-overlay-active');
                }
            }

            // --- Fonctions pour le Menu Profil ---
            function toggleProfileDropdown() {
                if (profileDropdown) {
                    profileDropdown.classList.toggle('hidden');
                }
            }

            // --- √âcouteurs d'√©v√©nements pour la Sidebar ---
            if (hamburgerBtn && sidebar) {
                hamburgerBtn.addEventListener('click', openSidebar);
            }
            if (closeSidebarBtn && sidebar) {
                closeSidebarBtn.addEventListener('click', closeSidebar);
            }
            if (sidebarOverlay && sidebar) {
                sidebarOverlay.addEventListener('click', closeSidebar);
            }
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && sidebarVisible && sidebar) {
                    closeSidebar();
                }
            });

            // --- √âcouteurs d'√©v√©nements pour le Menu Profil ---
            if (profileMenuButton) {
                profileMenuButton.addEventListener('click', function (event) {
                    event.stopPropagation(); 
                    toggleProfileDropdown();
                });
            }

            document.addEventListener('click', function (event) {
                if (profileDropdown && !profileDropdown.classList.contains('hidden')) {
                    if (!profileMenuButton.contains(event.target) && !profileDropdown.contains(event.target)) {
                        profileDropdown.classList.add('hidden');
                    }
                }
            });

            // =======================================================
            // D√âBUT DU SCRIPT POUR LE MENU D√âROULANT "CR√âER"
            // =======================================================
            
            // S√©lectionne les √©l√©ments du DOM
            const createDropdownButton = document.getElementById('createDropdownButton');
            const createDropdownMenu = document.getElementById('createDropdownMenu');

            // Fonction pour basculer l'affichage du menu
            function toggleCreateDropdown() {
                createDropdownMenu.classList.toggle('hidden');
            }

            // Ouvre/Ferme le menu au clic sur le bouton
            if (createDropdownButton) {
                createDropdownButton.addEventListener('click', function (event) {
                    // Emp√™che le clic de se propager et de fermer le menu imm√©diatement
                    event.stopPropagation(); 
                    toggleCreateDropdown();
                });
            }

            // Ferme le menu si l'utilisateur clique n'importe o√π ailleurs sur la page
            document.addEventListener('click', function (event) {
                // V√©rifie si le menu est visible et si le clic est √† l'ext√©rieur
                if (createDropdownMenu && !createDropdownMenu.classList.contains('hidden')) {
                    if (!createDropdownButton.contains(event.target) && !createDropdownMenu.contains(event.target)) {
                        createDropdownMenu.classList.add('hidden');
                    }
                }
            });
            // =======================================================
            // FIN DU SCRIPT POUR LE MENU D√âROULANT "CR√âER"
            // =======================================================


            // --- Actions sur les boutons (exemples) ---
            const filterBtn = document.querySelector('button:has(.fa-filter)');
            if(filterBtn) {
                filterBtn.addEventListener('click', () => alert('Fonctionnalit√© de filtrage √† impl√©menter'));
            }
        });
    </script>
    {% endblock %}
</body>
</html>